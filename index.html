<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grey Day ‚Äî Map & Weather</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .grain::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:.18;
      mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
    }
    .caps{letter-spacing:.22em;}
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-900">
  <div class="relative min-h-screen overflow-hidden">

    <!-- Background -->
    <div class="absolute inset-0">
      <div class="absolute -left-32 top-10 h-[520px] w-[520px] rounded-full bg-cyan-300/25 blur-[90px]"></div>
      <div class="absolute left-40 top-24 h-[540px] w-[540px] rounded-full bg-sky-600/25 blur-[100px]"></div>
      <div class="absolute right-[-140px] bottom-[-140px] h-[620px] w-[620px] rounded-full bg-slate-900/70 blur-[80px]"></div>
      <div class="absolute inset-0 bg-gradient-to-b from-black/10 via-black/30 to-black/70"></div>
      <div class="grain absolute inset-0"></div>
    </div>

    <!-- Content -->
    <div class="relative mx-auto max-w-6xl px-6 py-8">

      <!-- Top bar -->
      <!-- Top bar -->
<nav class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">

  <!-- Left nav links (hidden on mobile) -->
  <div id="navLinks" class="hidden md:flex flex-wrap items-center gap-2">
    <a id="favouritesBtn" href="favourites.html"
      class="rounded-full bg-white/10 px-4 py-2 text-[12px] font-semibold text-white/80 hover:bg-white/15 active:bg-white/20 transition">
      Favourites
    </a>

    <a id="todaysPlanBtn" href="todaysplan.html"
      class="rounded-full bg-white/10 px-4 py-2 text-[12px] font-semibold text-white/80 hover:bg-white/15 active:bg-white/20 transition">
      Today's Plan
    </a>

    <a id="weatherBtn" href="weather.html"
      class="rounded-full bg-white/10 px-4 py-2 text-[12px] font-semibold text-white/80 hover:bg-white/15 active:bg-white/20 transition">
      Weather
    </a>
  </div>

  <!-- Center logo (bigger) -->
  <div class="flex items-center justify-center">
    <div class="text-[18px] font-black uppercase caps text-white/85">
      Grey Day
    </div>
  </div>

  <!-- Right search + profile + menu -->
  <div class="relative flex items-center gap-2 justify-end">

    <form id="searchForm" class="w-full md:w-[420px]" role="search">
      <label for="search" class="sr-only">Search city</label>
      <input
        id="search"
        name="q"
        placeholder="Search city (e.g., Vancouver)"
        class="w-full rounded-full bg-white/55 backdrop-blur-xl ring-1 ring-white/25 px-4 py-2.5 text-[12px] text-slate-950 placeholder:text-slate-600/70 outline-none focus:ring-2 focus:ring-cyan-500/40"
      />
    </form>

    <a href="profile.html" id="profileBtn" aria-label="Profile"
      class="shrink-0 rounded-full bg-white/10 p-2.5 text-white/80 hover:bg-white/15 active:bg-white/20 transition inline-flex items-center justify-center">
      <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M20.59 22C20.59 18.13 16.74 15 12 15C7.26 15 3.41 18.13 3.41 22"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </a>

    <!-- Menu button only on mobile -->
    <button id="mobileMenuBtn" type="button" aria-label="Menu" aria-expanded="false"
      class="md:hidden rounded-full bg-white/10 px-4 py-2 text-[12px] font-semibold text-white/80 hover:bg-white/15 active:bg-white/20 transition">
      Menu
    </button>

    <!-- Mobile dropdown -->
    <div id="mobileDropdown"
      class="md:hidden hidden absolute right-0 top-[52px] w-56 rounded-[18px] bg-white/55 backdrop-blur-xl ring-1 ring-white/25 shadow-[0_20px_60px_rgba(0,0,0,0.35)] overflow-hidden">
      <a href="favourites.html"
        class="block px-4 py-3 text-[12px] font-semibold text-slate-900 hover:bg-black/10 transition">
        Favourites
      </a>
      <a href="todaysplan.html"
        class="block px-4 py-3 text-[12px] font-semibold text-slate-900 hover:bg-black/10 transition">
        Today's Plan
      </a>
      <a href="weather.html"
        class="block px-4 py-3 text-[12px] font-semibold text-slate-900 hover:bg-black/10 transition">
        Weather
      </a>
      <a href="profile.html"
        class="block px-4 py-3 text-[12px] font-semibold text-slate-900 hover:bg-black/10 transition border-t border-black/10">
        Profile
      </a>
    </div>
  </div>
</nav>


      <!-- Header line -->
      <div class="mt-6 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <div class="text-[12px] font-semibold uppercase caps text-white/75">Map + Weather</div>
          <div class="mt-2 text-[34px] leading-none font-black tracking-tight text-white">
            Explore with <span class="text-white/90">weather context</span>
          </div>
          <div class="mt-3 text-[11px] text-white/55 max-w-[56ch]">
            Search a city, drop pins, refresh the weather, and find rainy-day activities nearby.
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <button id="searchBtn" type="submit" form="searchForm"
            class="rounded-full bg-white/10 px-4 py-2 text-[12px] font-semibold text-white/80 hover:bg-white/15 active:bg-white/20 transition">
            Search
          </button>
          <button id="locateBtn" type="button"
            class="rounded-full bg-white/10 px-4 py-2 text-[12px] font-semibold text-white/80 hover:bg-white/15 active:bg-white/20 transition">
            Use my location
          </button>
        </div>
      </div>

      <!-- Main grid -->
      <div class="mt-8 grid grid-cols-1 lg:grid-cols-[1fr_420px] gap-6 items-stretch">

        <!-- Map card -->
        <section class="rounded-[26px] bg-white/55 backdrop-blur-xl ring-1 ring-white/25 shadow-[0_20px_60px_rgba(0,0,0,0.35)] overflow-hidden">
          <div class="px-6 pt-6 pb-4 border-b border-black/10">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-[11px] font-semibold uppercase caps text-slate-800/80">Map</div>
                <h2 class="mt-1 text-[20px] font-extrabold tracking-tight text-slate-950">Your area</h2>
              </div>
              <div class="text-[10px] text-slate-700/60">Tip: click the map to explore</div>
            </div>
          </div>
          <div id="map" class="h-[58vh] lg:h-[78vh] w-full"></div>
        </section>

        <!-- Panel card -->
        <aside class="rounded-[26px] bg-white/55 backdrop-blur-xl ring-1 ring-white/25 shadow-[0_20px_60px_rgba(0,0,0,0.35)] overflow-hidden">
          <div class="px-6 pt-6 pb-4 border-b border-black/10">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-[11px] font-semibold uppercase caps text-slate-800/80">Today‚Äôs vibe</div>
                <h2 class="mt-1 text-[20px] font-extrabold tracking-tight text-slate-950">Weather + Activities</h2>
              </div>
              <button id="refreshBtn"
                class="rounded-full bg-black/10 px-3 py-1 text-[11px] font-semibold text-slate-800/80 hover:bg-black/15 active:bg-black/20 transition"
                type="button">
                Refresh
              </button>
            </div>
            <p id="statusNote" class="mt-2 text-[11px] text-slate-700/70">Status: waiting</p>
          </div>

          <div class="p-6 space-y-5">
            <div id="weather-app" class="rounded-[18px] bg-white/45 ring-1 ring-black/10 p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-[10px] font-semibold uppercase tracking-[0.18em] text-slate-700/70">City</div>
                  <div id="city" class="mt-1 text-[18px] font-extrabold tracking-tight text-slate-950">Vancouver</div>
                  <div id="desc" class="mt-1 text-[12px] text-slate-700/70">Loading...</div>
                </div>
                <div class="text-right">
                  <div class="text-[10px] font-semibold uppercase tracking-[0.18em] text-slate-700/70">Temp</div>
                  <div id="temp" class="mt-1 text-[30px] font-black tracking-tight text-slate-950">--¬∞C</div>
                </div>
              </div>

              <div class="mt-4 flex flex-wrap gap-2">
                <button id="legacyRefreshBtn" type="button"
                  class="rounded-full bg-black/10 px-4 py-2 text-[12px] font-semibold text-slate-800/80 hover:bg-black/15 active:bg-black/20 transition">
                  Legacy Refresh
                </button>

                <button id="testKeyBtn" type="button"
                  class="rounded-full bg-black/10 px-4 py-2 text-[12px] font-semibold text-slate-800/80 hover:bg-black/15 active:bg-black/20 transition">
                  Test API Key
                </button>
              </div>
            </div>

            <div id="activities-app" class="rounded-[18px] bg-white/45 ring-1 ring-black/10 p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="text-[10px] font-semibold uppercase tracking-[0.18em] text-slate-700/70">Rainy day</div>
                  <div id="activities-title" class="mt-1 text-[16px] font-extrabold tracking-tight text-slate-950">
                    üåßÔ∏è Activities near you
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-[10px] font-semibold uppercase tracking-[0.18em] text-slate-700/70">Distance</div>
                  <div class="mt-1 text-[12px] font-semibold text-slate-900/70">
                    <span id="distance-display">--</span>
                  </div>
                </div>
              </div>

              <div class="mt-3">
                <span class="inline-flex items-center rounded-full bg-black/5 px-3 py-1 text-[11px] font-semibold text-slate-700/70 ring-1 ring-black/10">
                  üîç Search radius: 5km
                </span>
              </div>

              <button id="findActivitiesBtn" type="button"
                class="mt-4 w-full rounded-full bg-black/10 px-4 py-3 text-[12px] font-semibold text-slate-900 hover:bg-black/15 active:bg-black/20 transition">
                Find Activities Near Me
              </button>

              <div id="activities-loading" class="mt-4 text-[12px] text-slate-700/70" style="display:none;">
                Finding activities...
              </div>

              <div id="activities-list" class="mt-4 space-y-3"></div>
            </div>

            <p id="keyNote" class="text-[10px] text-slate-700/60">
              Demo mode: no API key provided ‚Äî add an OpenWeatherMap key in maps.js to fetch live data.
            </p>
          </div>
        </aside>
      </div>

      <div class="mt-8 text-center text-[11px] tracking-wide text-white/45">
        Grey Day ‚Ä¢ JourneyHacks
      </div>
    </div>
  </div>

  <!-- Scripts -->
   <script>
  document.addEventListener("DOMContentLoaded", () => {
    const locateBtn = document.getElementById("locateBtn");
    const statusEl = document.getElementById("statusNote");

    if (!locateBtn) return;

    locateBtn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        if (statusEl) statusEl.textContent = "Geolocation not supported in this browser.";
        return;
      }

      // Geolocation requires HTTPS or localhost
      if (location.protocol !== "https:" && location.hostname !== "localhost" && location.hostname !== "127.0.0.1") {
        if (statusEl) statusEl.textContent = "Geolocation blocked (use HTTPS or localhost).";
        return;
      }

      if (statusEl) statusEl.textContent = "Getting your location‚Ä¶";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude } = pos.coords;
          if (statusEl) statusEl.textContent = `Location set: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;

          // If your existing code exposes a function, call it:
          if (typeof window.setUserLocation === "function") {
            window.setUserLocation(latitude, longitude);
          }

          // Also fire a custom event your scripts can listen to
          window.dispatchEvent(new CustomEvent("user-location", {
            detail: { lat: latitude, lng: longitude }
          }));
        },
        (err) => {
          console.warn("Geolocation error:", err);
          if (statusEl) statusEl.textContent = "Couldn‚Äôt get your location (permission denied / timeout).";
        },
        { enableHighAccuracy: true, timeout: 8000 }
      );
    });
  });
</script>

  <script>
    // Mobile dropdown behavior
    document.addEventListener("DOMContentLoaded", () => {
      const menuBtn = document.getElementById("mobileMenuBtn");
      const dropdown = document.getElementById("mobileDropdown");
  
      if (menuBtn && dropdown) {
        menuBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const open = dropdown.classList.toggle("hidden") === false;
          menuBtn.setAttribute("aria-expanded", open ? "true" : "false");
        });
  
        // Close when tapping outside
        document.addEventListener("click", (e) => {
          if (!dropdown.classList.contains("hidden")) {
            const clickedInside = dropdown.contains(e.target) || menuBtn.contains(e.target);
            if (!clickedInside) {
              dropdown.classList.add("hidden");
              menuBtn.setAttribute("aria-expanded", "false");
            }
          }
        });
  
        // Close after clicking a link
        dropdown.querySelectorAll("a").forEach(a => {
          a.addEventListener("click", () => {
            dropdown.classList.add("hidden");
            menuBtn.setAttribute("aria-expanded", "false");
          });
        });
      }
    });
  </script>
  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    if (window.GOOGLE_MAPS_API_KEY && window.GOOGLE_MAPS_API_KEY.trim() && window.GOOGLE_MAPS_API_KEY !== 'AIzaSyDummyKey') {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_MAPS_API_KEY}&libraries=places`;
      script.defer = true;
      document.head.appendChild(script);
    }
  </script>

  <!-- API Keys Quick-Edit UI -->
  <script>
    // Render a small keys control in the panel for convenience (no persistence beyond sessionStorage)
    function renderApiKeyControls() {
      const panel = document.querySelector('.panel');
      if (!panel || document.getElementById('api-key-controls')) return;

      const container = document.createElement('div');
      container.id = 'api-key-controls';
      container.className = 'api-key-controls';
      container.innerHTML = `
        <div style="margin-top:6px;padding:8px;border-radius:8px;background:#f7f9fc;border:1px solid #eef3fb">
          <div style="display:flex;gap:8px;flex-direction:column">
            <label style="font-size:12px;color:#374151">Google Maps Key</label>
            <input id="apiGoogleInput" placeholder="Paste Google Maps API key (session only)" style="padding:8px;border-radius:6px;border:1px solid #e6eef9" />
            <label style="font-size:12px;color:#374151">OpenWeather Key</label>
            <input id="apiWeatherInput" placeholder="OpenWeather API key" style="padding:8px;border-radius:6px;border:1px solid #e6eef9" />
            <label style="font-size:12px;color:#374151">Gemini Key</label>
            <input id="apiGeminiInput" placeholder="Gemini API key (optional)" style="padding:8px;border-radius:6px;border:1px solid #e6eef9" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="saveApiKeysBtn">Save & Apply (session)</button>
              <button id="clearApiKeysBtn" style="background:#ef4444">Clear</button>
              <button id="reloadPageBtn" style="background:#6b7280">Reload</button>
            </div>
            <div id="apiKeyStatus" style="font-size:12px;color:#6b7280;margin-top:6px"></div>
          </div>
        </div>
      `;
      panel.insertBefore(container, panel.firstChild);

      // Fill inputs if we have session keys
      try {
        const g = sessionStorage.getItem('GOOGLE_MAPS_API_KEY') || '';
        const w = sessionStorage.getItem('WEATHER_API_KEY') || '';
        const gm = sessionStorage.getItem('GEMINI_API_KEY') || '';
        document.getElementById('apiGoogleInput').value = g;
        document.getElementById('apiWeatherInput').value = w;
        document.getElementById('apiGeminiInput').value = gm;
      } catch (e) {}

      document.getElementById('saveApiKeysBtn').addEventListener('click', () => {
        const g = document.getElementById('apiGoogleInput').value.trim();
        const w = document.getElementById('apiWeatherInput').value.trim();
        const gm = document.getElementById('apiGeminiInput').value.trim();
        try {
          if (g) sessionStorage.setItem('GOOGLE_MAPS_API_KEY', g);
          else sessionStorage.removeItem('GOOGLE_MAPS_API_KEY');
          if (w) sessionStorage.setItem('WEATHER_API_KEY', w);
          else sessionStorage.removeItem('WEATHER_API_KEY');
          if (gm) sessionStorage.setItem('GEMINI_API_KEY', gm);
          else sessionStorage.removeItem('GEMINI_API_KEY');

          // Apply to window for immediate use (maps.js may require reload for initial load)
          window.GOOGLE_MAPS_API_KEY = g || undefined;
          window.WEATHER_API_KEY = w || undefined;
          window.GEMINI_API_KEY = gm || undefined;

          const status = document.getElementById('apiKeyStatus');
          status.textContent = 'Keys saved to session. For Maps JS to take effect, press Reload.';
        } catch (e) {
          console.warn('[index] Failed to save keys', e);
        }
      });

      document.getElementById('clearApiKeysBtn').addEventListener('click', () => {
        sessionStorage.removeItem('GOOGLE_MAPS_API_KEY');
        sessionStorage.removeItem('WEATHER_API_KEY');
        sessionStorage.removeItem('GEMINI_API_KEY');
        window.GOOGLE_MAPS_API_KEY = undefined;
        window.WEATHER_API_KEY = undefined;
        window.GEMINI_API_KEY = undefined;
        document.getElementById('apiGoogleInput').value = '';
        document.getElementById('apiWeatherInput').value = '';
        document.getElementById('apiGeminiInput').value = '';
        document.getElementById('apiKeyStatus').textContent = 'Keys cleared from session.';
      });

      document.getElementById('reloadPageBtn').addEventListener('click', () => location.reload());
    }

    // Render controls after DOM is ready
    window.addEventListener('DOMContentLoaded', () => setTimeout(renderApiKeyControls, 200));

    /* --------------------------------------------
       Curated plan integration (re-uses Places & Details logic)
       Populates the existing #activities-list with cafe/dinner/relax picks
    -------------------------------------------- */
    function placeToCard(place, userLat, userLng) {
      const lat = Number(place?.geometry?.location?.lat);
      const lng = Number(place?.geometry?.location?.lng ?? place?.geometry?.location?.lon);

      const distance = (isFinite(lat) && isFinite(lng))
        ? (function() { const R = 6371; const dLat = (lat - userLat) * Math.PI/180; const dLon = (lng - userLng) * Math.PI/180; const a = Math.sin(dLat/2)**2 + Math.cos(userLat * Math.PI/180) * Math.cos(lat * Math.PI/180) * Math.sin(dLon/2)**2; const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; })()
        : null;

      const rating = place.rating != null ? Number(place.rating).toFixed(1) : "‚Äî";
      const total = place.user_ratings_total != null ? place.user_ratings_total : "";
      const address = place.formatted_address || place.vicinity || "";
      const topReview = (place.reviews && place.reviews[0] && place.reviews[0].text) ? place.reviews[0] : null;

      const mapsUrl = place.place_id
        ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name || "place")}&query_place_id=${encodeURIComponent(place.place_id)}`
        : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name || "place")}`;

      return `
        <div class="rounded-[12px] bg-white/45 ring-1 ring-black/10 p-3">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="text-[13px] font-extrabold tracking-tight text-slate-950 truncate">${(place.name || 'Untitled')}</div>
              <div class="mt-1 flex items-center gap-2 text-[11px] text-slate-700/70">
                <span class="font-semibold text-slate-900/70">‚òÖ ${rating}${total ? ` (${total})` : ''}</span>
                ${distance != null ? `<span class="text-slate-700/50">‚Ä¢</span><span>${(distance < 1 ? Math.round(distance*1000)+'m' : distance.toFixed(1)+'km')}</span>` : ''}
              </div>
              ${address ? `<div class="mt-2 text-[11px] text-slate-700/65">${address}</div>` : ''}
              ${topReview ? `<div class="mt-2 text-[11px] text-slate-800/80">‚Äú${(topReview.text||'').slice(0,140)}${topReview.text && topReview.text.length>140?'‚Ä¶':''}‚Äù</div>` : ''}
            </div>
            <a class="shrink-0 rounded-full bg-black/10 px-3 py-1 text-[11px] font-semibold text-slate-800/80 hover:bg-black/15 active:bg-black/20 transition" href="${mapsUrl}" target="_blank" rel="noreferrer">Maps</a>
          </div>
        </div>
      `;
    }

    async function curatePlanIndex() {
      const listEl = document.getElementById('activities-list');
      const loading = document.getElementById('activities-loading');
      const status = document.getElementById('statusNote');
      const user = window.lastCoords || { lat: 49.2827, lng: -123.1207 };
      loading.style.display = 'block';
      listEl.innerHTML = '';
      if (status) status.textContent = 'Curating activities‚Ä¶';

      try {
        // Use the activities.js findNearbyPlaces (JS/REST/demo fallback) to get a broad pool
        const pool = await findNearbyPlaces(user.lat, user.lng, DEFAULT_SEARCH_RADIUS) || [];
        const seen = new Set();
        const unique = [];
        for (const p of pool) {
          if (!p || !p.place_id) continue;
          if (!seen.has(p.place_id)) { seen.add(p.place_id); unique.push(p); }
        }

        if (unique.length === 0) {
          const demo = (typeof getDemoActivities === 'function') ? getDemoActivities(user.lat, user.lng) : [];
          listEl.innerHTML = demo.map(p => placeToCard(p, user.lat, user.lng)).join('');
          if (status) status.textContent = 'Showing demo activities (Places not available).';
          return;
        }

        // Categorize by simple heuristics (type names or keywords)
        const cafes = unique.filter(p => (p.types || []).some(t => /cafe|coffee|bakery|barista|espresso/.test(t))).slice(0,3);
        const dinners = unique.filter(p => (p.types || []).some(t => /restaurant|food|diner|bar/.test(t))).slice(0,3);
        const relax = unique.filter(p => (p.types || []).some(t => /bar|library|museum|store|book_store|art_gallery/.test(t))).slice(0,3);

        const picks = [...cafes, ...dinners, ...relax].slice(0,9);

        // Enrich top picks with details
        const enriched = await Promise.all(picks.map(async p => {
          try { const d = await getPlaceDetails(p.place_id); return d ? { ...p, ...d } : p; } catch(e){ return p; }
        }));

        listEl.innerHTML = enriched.map(p => placeToCard(p, user.lat, user.lng)).join('');
        if (status) status.textContent = `Curated ${enriched.length} activities from Places`;
      } catch (err) {
        console.warn('[index] curatePlanIndex failed', err);
        const demo = (typeof getDemoActivities === 'function') ? getDemoActivities(user.lat, user.lng) : [];
        listEl.innerHTML = demo.map(p => placeToCard(p, user.lat, user.lng)).join('');
        if (status) status.textContent = 'Error curating (see console); showing demo activities.';
      } finally {
        loading.style.display = 'none';
      }
    }
  </script>
  <script>
    // Wire up curated plan triggers
    document.addEventListener('DOMContentLoaded', () => {
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', () => setTimeout(curatePlanIndex, 50));

      window.addEventListener('user-location', (e) => {
        try { window.lastCoords = { lat: e.detail.lat, lng: e.detail.lng }; } catch (err) {}
        setTimeout(curatePlanIndex, 200);
        // Also trigger the activities search after the location is set (short delay to allow scripts to initialize)
        setTimeout(() => {
          try { if (window.findActivities) window.findActivities(); } catch (err) { console.warn('[index] findActivities call failed', err); }
        }, 300);
      });

      // Run once on load after a short delay to allow auto-locate to complete
      setTimeout(() => { try { curatePlanIndex(); } catch(e){} }, 2000);
    });
  </script>
  <script src="maps.js" defer></script>
  <script src="index.js" defer></script>
  <script src="activities.js" defer></script>
  <script src="chatbot.js" defer></script>
  <style>
    /* --- Floating Chatbot (minimal styling) --- */
    #gemini-chatbot{
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 999999;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
  
    .chatbot-toggle{
      width: 56px;
      height: 56px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.9);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      cursor: pointer;
      transition: transform .15s ease, background .15s ease;
    }
    .chatbot-toggle:hover{ background: rgba(255,255,255,.16); }
    .chatbot-toggle:active{ transform: scale(.98); }
  
    .chatbot-window{
      width: min(92vw, 380px);
      height: 520px;
      margin-bottom: 12px;
      border-radius: 22px;
      overflow: hidden;
      background: rgba(255,255,255,.60);
      border: 1px solid rgba(255,255,255,.28);
      backdrop-filter: blur(18px);
      box-shadow: 0 28px 80px rgba(0,0,0,.50);
      display: none;
    }
  
    /* when open */
    #gemini-chatbot.open .chatbot-window{ display: flex; flex-direction: column; }
  
    .chatbot-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 14px;
      border-bottom: 1px solid rgba(0,0,0,.10);
    }
    .chatbot-header-content{ display: flex; gap: 10px; align-items: center; }
    .chatbot-header h3{ font-weight: 800; font-size: 14px; line-height: 1.1; color: rgba(2,6,23,.92); }
    .chatbot-subtitle{ font-size: 11px; color: rgba(2,6,23,.55); margin-top: 2px; }
    .chatbot-close{
      width: 34px; height: 34px; border-radius: 999px;
      background: rgba(0,0,0,.08);
      color: rgba(2,6,23,.72);
      font-size: 18px;
    }
    .chatbot-close:hover{ background: rgba(0,0,0,.12); }
  
    .chatbot-messages{
      flex: 1;
      overflow: auto;
      padding: 14px;
    }
    .chatbot-message{ margin-bottom: 10px; }
    .chatbot-message .message-content{
      font-size: 12px;
      line-height: 1.35;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.08);
    }
    .chatbot-user .message-content{
      background: rgba(2,6,23,.10);
      color: rgba(2,6,23,.85);
      margin-left: 36px;
    }
    .chatbot-assistant .message-content{
      background: rgba(255,255,255,.70);
      color: rgba(2,6,23,.85);
      margin-right: 36px;
    }
  
    .chatbot-input-container{
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.45);
    }
    .chatbot-input{
      flex: 1;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 12px;
      outline: none;
      border: 1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.70);
    }
    .chatbot-send{
      width: 42px; height: 42px;
      border-radius: 999px;
      display: grid; place-items: center;
      background: rgba(0,0,0,.10);
      color: rgba(2,6,23,.8);
    }
    .chatbot-send:hover{ background: rgba(0,0,0,.14); }
  
    .typing-indicator{ display:flex; gap:6px; align-items:center; }
    .typing-indicator span{
      width: 6px; height: 6px; border-radius: 999px;
      background: rgba(2,6,23,.45);
      animation: bounce 1s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(2){ animation-delay: .12s; }
    .typing-indicator span:nth-child(3){ animation-delay: .24s; }
    @keyframes bounce{ 0%,100%{ transform: translateY(0); opacity:.5; } 50%{ transform: translateY(-4px); opacity:1; } }
  </style>
  
</body>
</html>
